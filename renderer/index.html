<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meguidnafen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="header-left">
      <div><strong>Meguidnafen</strong></div>
      <div id="mednafenPath" class="small path-text"></div>
    </div>
    <div class="header-right">
      <button id="btnSetExe">Set mednafen.exe Path</button>
      <button id="btnToggleDarkMode">Dark Mode</button>
    </div>
  </header>
  <div class="container">
    <div class="row button-row">
      <select id="systemDropdown"></select>
      <button id="btnSelectRomFolder">Set ROM Folder</button>
      <button id="btnScan">Scan Selected Folder</button>
    </div>
    <div class="row" style="text-align: center;">
      <div id="selectedFolderPath" class="small path-text">No folder selected</div>
    </div>
    <div class="row delete-row">
        <button id="btnDeleteSelected" class="delete-button" disabled>Delete Selected</button>
    </div>
    <div class="row search-row">
      <input type="text" id="searchBar" placeholder="Search for a game..." />
    </div>
    <div class="game-list" id="gameList"></div>
  </div>

  <script>
    const mednafenPathEl = document.getElementById('mednafenPath');
    const searchBarEl = document.getElementById('searchBar');
    const systemDropdown = document.getElementById('systemDropdown');
    const selectedFolderPathEl = document.getElementById('selectedFolderPath');
    const btnDeleteSelected = document.getElementById('btnDeleteSelected');
    const btnToggleDarkMode = document.getElementById('btnToggleDarkMode');
    let allGames = [];
    let systemFolders = {};

    const ALL_SYSTEMS = [
        'PlayStation',
        'Sega Saturn',
        'Super Nintendo Entertainment System',
        'Nintendo Entertainment System',
        'Game Boy Advance',
        'Game Boy / Color',
        'PC Engine SuperGrafx',
        'Sega Genesis',
        'Master System',
        'Game Gear',
        'Atari 2600',
        'Atari Lynx',
        'PC-FX',
        'Virtual Boy',
        'WonderSwan',
        'Neo Geo Pocket / Color'
    ].sort();

    function populateSystemDropdown() {
        ALL_SYSTEMS.forEach(system => {
            const option = document.createElement('option');
            option.value = system;
            option.textContent = system;
            systemDropdown.appendChild(option);
        });
    }

    async function loadMednafenPath(){
      const p = await window.api.getMednafenPath();
      mednafenPathEl.textContent = p ? ('mednafen: ' + p) : 'mednafen: (using system PATH)';
    }

    async function loadSystemFolders() {
        systemFolders = await window.api.getSystemFolders();
        updateSelectedFolderPath();
    }

    async function loadDarkModeState() {
      const isDarkMode = await window.api.getDarkModeState();
      const body = document.body;

      if (isDarkMode) {
        body.classList.add('dark-mode');
        btnToggleDarkMode.textContent = 'Light Mode';
      } else {
        body.classList.remove('dark-mode');
        btnToggleDarkMode.textContent = 'Dark Mode';
      }
    }
    
    loadMednafenPath();
    populateSystemDropdown();
    loadSystemFolders();
    loadDarkModeState();

    function updateSelectedFolderPath() {
        const selectedSystem = systemDropdown.value;
        const folderPath = systemFolders[selectedSystem];
        selectedFolderPathEl.textContent = folderPath || 'No folder selected';
    }

    systemDropdown.addEventListener('change', updateSelectedFolderPath);
    
    // Logic for delete button state
    function updateDeleteButtonState() {
        const selectedCount = document.querySelectorAll('.game-list .card.selected').length;
        btnDeleteSelected.disabled = selectedCount === 0;
    }

    btnDeleteSelected.addEventListener('click', async () => {
      const selectedIds = Array.from(document.querySelectorAll('.game-list .card.selected'))
          .map(card => card.dataset.gameId);
      
      if (selectedIds.length > 0) {
          const confirmation = confirm(`Are you sure you want to delete ${selectedIds.length} games? This will not delete the actual files.`);
          if (confirmation) {
              await window.api.removeGamesByIds(selectedIds);
              // The local game list is now stale. Let's refresh it.
              await refreshList(searchBarEl.value); 
              
              // This is the critical line. It must be here.
              updateDeleteButtonState();
          }
      }
    });

    // Delegated event listener for game cards to handle selection
    document.getElementById('gameList').addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (card) {
            // Prevent run button from triggering card selection
            if (e.target.matches('[data-run]')) {
                return;
            }
            if (e.ctrlKey || e.metaKey) { // For Ctrl (Windows/Linux) or Cmd (Mac)
                card.classList.toggle('selected');
            } else {
                const isSelected = card.classList.contains('selected');
                document.querySelectorAll('.game-list .card').forEach(c => c.classList.remove('selected'));
                if (!isSelected) {
                    card.classList.add('selected');
                }
            }
            updateDeleteButtonState();
        }
    });


    
    btnToggleDarkMode.addEventListener('click', async () => {
      const body = document.body;
      body.classList.toggle('dark-mode');
      const isNowDarkMode = body.classList.contains('dark-mode');

      btnToggleDarkMode.textContent = isNowDarkMode 
        ? 'Light Mode' 
        : 'Dark Mode';

      await window.api.setDarkModeState(isNowDarkMode);
    });

    document.getElementById('btnSetExe').addEventListener('click', async ()=>{
      const execPath = await window.api.selectMednafenExec();
      if (!execPath) return;
      loadMednafenPath();
    });

    document.getElementById('btnSelectRomFolder').addEventListener('click', async ()=>{
        const selectedSystem = systemDropdown.value;
        const folder = await window.api.selectFolder(selectedSystem);
        if (!folder) return;
        systemFolders[selectedSystem] = folder;
        updateSelectedFolderPath();
    });

    document.getElementById('btnScan').addEventListener('click', async ()=>{
        const selectedSystem = systemDropdown.value;
        if (!systemFolders[selectedSystem]) return alert('Select a ROM folder for ' + selectedSystem + ' first');
      const res = await window.api.scanFolder(selectedSystem);
      if (res && res.error) return alert(res.error);
      await refreshList();
    });

    async function refreshList(searchQuery = searchBarEl.value){
        if (searchQuery === searchBarEl.value) {
            allGames = await window.api.getGames();
        }

        const filteredGames = allGames.filter(game => 
            game.name.toLowerCase().includes(searchQuery.toLowerCase())
        );

      const container = document.getElementById('gameList');
      container.innerHTML = '';
      
      const groupedGames = filteredGames.reduce((acc, game) => {
        (acc[game.system] = acc[game.system] || []).push(game);
        return acc;
      }, {});

      for (const system in groupedGames) {
        const systemGroupEl = document.createElement('div');
        systemGroupEl.className = 'system-group';
        systemGroupEl.innerHTML = `<h2 class="system-header">
            <span class="toggle-icon">▼</span> ${escapeHtml(system)}
        </h2>
        <div class="game-list-per-system"></div>`;
        
        const gamesForSystem = groupedGames[system];
        const gameListContainer = systemGroupEl.querySelector('.game-list-per-system');

        for (const g of gamesForSystem) {
          const el = document.createElement('div'); el.className='card';
          el.dataset.gameId = g.id;
          el.innerHTML = `
            <div class="card-content">
              <div class="game-details">
                <strong>${escapeHtml(g.name)}</strong>
              </div>
              <div style='display:flex;flex-direction:column;gap:6px'>
                <button class="run-button" data-run='${g.path}'>Run</button>
              </div>
            </div>`;
          gameListContainer.appendChild(el);
        }
        container.appendChild(systemGroupEl);
      }

      container.querySelectorAll('[data-run]').forEach(b=>{
        b.addEventListener('click', async (ev)=>{
          const p = ev.currentTarget.getAttribute('data-run');
          const res = await window.api.runGame(p);
          if (res && res.error) alert('Error: ' + res.error);
        });
      });

      container.querySelectorAll('.system-header').forEach(header => {
        header.addEventListener('click', () => {
            const gameList = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (gameList.style.display === 'none') {
                gameList.style.display = 'flex';
                icon.textContent = '▼';
            } else {
                gameList.style.display = 'none';
                icon.textContent = '▶';
            }
        });
      });
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

    refreshList();
    searchBarEl.addEventListener('keyup', () => refreshList(searchBarEl.value));

    window.api.onRunError(msg => alert('Mednafen run error: ' + msg));
    window.api.onRunClosed(code => console.log('Mednafen closed with code', code));
  </script>
</body>
</html>